<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Guru Wali</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Google Fonts untuk Inter dan Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Gaya & Animasi Kustom */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes confirmIcon {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out forwards;
        }
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
        .animate-confirm {
            animation: confirmIcon 0.5s ease-in-out;
        }

        /* Gaya Tombol Status */
        .btn-status {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            background-color: #e5e7eb;
            color: #4b5563;
            font-weight: 600;
            border: none;
            outline: none;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-status.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 0 0 rgba(59,130,246,0.4);
            animation: none;
        }
        .btn-status:not(.active) { opacity: 0.8; }
        .btn-status:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .hadir.active { background-color: #10b981; color: white; }
        .sakit.active { background-color: #f59e0b; color: white; }
        .izin.active { background-color: #3b82f6; color: white; }
        .alfa.active { background-color: #ef4444; color: white; }
        
        /* Gaya Kartu Menu */
        .menu-card {
            transition: all 0.3s ease;
        }
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(59,130,246,0.1);
        }

        /* Gaya Body & Summary Card */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
            background-attachment: fixed;
        }
        .summary-card {
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(59,130,246,0.1);
        }

        /* Gaya Tombol Export */
        #export-pdf-button {
            background: linear-gradient(135deg, #4f46e5, #3b82f6);
        }
        #export-pdf-button:hover {
            background: linear-gradient(135deg, #4338ca, #2563eb);
            transform: translateY(-2px);
        }
        
        /* Gaya Layar Pembuka (Landing Page) */
        .landing-page {
            position: fixed; inset: 0; background: linear-gradient(135deg, #2563eb, #3b82f6); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; color: white; font-family: 'Poppins', sans-serif;
            transition: opacity 0.5s ease-out;
        }
        .landing-page .text-content {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s ease-out forwards;
            animation-delay: 0.5s;
        }

        /* Gaya Dashboard baru (Tabs) */
        .tab-menu {
            transition: all 0.3s ease;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .tab-menu.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        /* Modal Notifikasi */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .modal-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Gaya Tabel Riwayat */
        .history-table-row:nth-child(even) {
            background-color: #f9fafb;
        }
        .history-table-row:hover {
            background-color: #f3f4f6;
            transition: background-color 0.2s ease-in-out;
        }

        /* Gaya Ikon Menu Baru */
        .menu-tab-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
        .menu-tab-text {
            display: none;
        }
        @media (min-width: 640px) {
            .menu-tab-text {
                display: inline;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">

    <!-- Layar Pembuka (Landing Page) -->
    <div id="landing-page" class="landing-page">
        <div class="max-w-xl text-content">
            <i class="fas fa-school text-8xl mb-8"></i>
            <h1 class="text-5xl font-extrabold mb-4 font-poppins">Aplikasi Absensi Digital</h1>
            <p class="text-xl font-light mb-10 font-inter">Solusi modern untuk mencatat kehadiran siswa dengan cepat dan rapi.</p>
            <button id="start-button" class="bg-white text-indigo-600 font-bold py-3 px-8 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-white focus:ring-opacity-50">
                <i class="fas fa-arrow-right mr-2"></i> Masuk
            </button>
        </div>
    </div>

    <!-- Aplikasi Utama -->
    <div id="main-app" class="max-w-4xl w-full bg-white p-6 sm:p-8 rounded-3xl shadow-2xl border border-gray-200 hidden">
        <h1 id="app-title" class="text-3xl font-bold text-center mb-2 text-gray-800">Absensi Guru Wali</h1>
        <p id="app-subtitle" class="text-center text-gray-500 mb-6">Dashboard untuk Ibu Harlina</p>

        <!-- Tombol Kembali -->
        <div id="back-button-container" class="mb-4 hidden">
            <button id="back-button" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors duration-200">
                <i class="fas fa-arrow-left mr-1"></i> Kembali ke Dashboard
            </button>
        </div>

        <!-- Dashboard Guru -->
        <div id="teacher-dashboard">
            <!-- Tampilan detail guru yang diperbarui -->
            <div id="teacher-details" class="bg-indigo-50 p-5 rounded-xl mb-6 border border-indigo-100">
                <div class="flex items-center mb-2">
                    <i class="fas fa-user-tie text-3xl text-indigo-700 mr-4"></i>
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-800" id="teacher-name">HARLINA BASO, S.Pd, Gr</h2>
                        <p class="text-indigo-700 font-medium text-sm"><i class="fas fa-id-card-alt mr-2"></i> NIP: <span id="teacher-nip">19830730 200902 2 001</span></p>
                        <p class="text-indigo-700 font-medium text-sm"><i class="fas fa-door-open mr-2"></i> Kelas: <span id="teacher-class">IX A</span></p>
                    </div>
                </div>
            </div>

            <!-- Tab Menu Dashboard -->
            <div class="flex border-b-2 border-gray-200 mb-6 font-semibold space-x-2 sm:space-x-4">
                <div id="menu-absen-siswa" class="tab-menu py-2 px-3 sm:px-4 active flex items-center">
                    <i class="fas fa-user-edit menu-tab-icon"></i>
                    <span class="menu-tab-text">Absen Siswa</span>
                </div>
                <div id="menu-data-siswa" class="tab-menu py-2 px-3 sm:px-4 flex items-center">
                    <i class="fas fa-table menu-tab-icon"></i>
                    <span class="menu-tab-text">Data Siswa</span>
                </div>
                <div id="menu-export-pdf" class="tab-menu py-2 px-3 sm:px-4 flex items-center">
                    <i class="fas fa-file-pdf menu-tab-icon"></i>
                    <span class="menu-tab-text">Ekspor PDF</span>
                </div>
                <div id="menu-export-excel" class="tab-menu py-2 px-3 sm:px-4 flex items-center">
                    <i class="fas fa-file-excel menu-tab-icon"></i>
                    <span class="menu-tab-text">Ekspor Excel</span>
                </div>
            </div>
            
            <!-- Area Konten (Tersembunyi Awalnya) -->
            <div id="content-container">
                <!-- Konten Absensi Harian -->
                <div id="student-list" class="space-y-3">
                    <!-- Tombol Aksi (Tandai Semua & Ekspor PDF) -->
                    <div id="action-buttons" class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                        <button id="mark-all-present" class="py-2 px-5 w-full sm:w-auto bg-gray-200 text-gray-800 font-medium rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-check-double mr-2"></i> Tandai Semua Hadir
                        </button>
                    </div>
                     <!-- Ringkasan Absensi -->
                    <div id="attendance-summary" class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Ringkasan Hari Ini</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="summary-card p-4 rounded-xl shadow bg-green-50 border border-green-100">
                                <i class="fas fa-check-circle text-green-500 text-xl mb-1"></i>
                                <p class="text-2xl font-bold text-green-700" id="count-hadir">0</p>
                                <p class="text-sm text-green-600 mt-1">Hadir</p>
                            </div>
                            <div class="summary-card p-4 rounded-xl shadow bg-yellow-50 border border-yellow-100">
                                <i class="fas fa-procedures text-yellow-500 text-xl mb-1"></i>
                                <p class="text-2xl font-bold text-yellow-700" id="count-sakit">0</p>
                                <p class="text-sm text-yellow-600 mt-1">Sakit</p>
                            </div>
                            <div class="summary-card p-4 rounded-xl shadow bg-blue-50 border border-blue-100">
                                <i class="fas fa-hand-paper text-blue-500 text-xl mb-1"></i>
                                <p class="text-2xl font-bold text-blue-700" id="count-izin">0</p>
                                <p class="text-sm text-blue-600 mt-1">Izin</p>
                            </div>
                            <div class="summary-card p-4 rounded-xl shadow bg-red-50 border border-red-100">
                                <i class="fas fa-times-circle text-red-500 text-xl mb-1"></i>
                                <p class="text-2xl font-bold text-red-700" id="count-alfa">0</p>
                                <p class="text-sm text-red-600 mt-1">Alfa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Konten Riwayat Absensi (Data Siswa) -->
                <div id="history-container" class="mt-8 pt-6 hidden">
                    <div class="p-6 bg-white rounded-xl shadow-md border border-gray-200">
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input id="history-search-input" type="text" placeholder="Cari nama siswa..." class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                            <input id="history-filter-date" type="date" class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                            <select id="history-filter-status" class="w-full sm:w-auto p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                                <option value="semua">Semua Status</option>
                                <option value="hadir">Hadir</option>
                                <option value="sakit">Sakit</option>
                                <option value="izin">Izin</option>
                                <option value="alfa">Alfa</option>
                            </select>
                        </div>
                        <div id="history-table-container" class="overflow-x-auto">
                            <!-- Tabel riwayat akan di-render di sini -->
                        </div>
                    </div>
                </div>

                <!-- Konten Ekspor PDF -->
                <div id="export-pdf-content" class="p-6 hidden">
                    <div class="text-center">
                        <i class="fas fa-file-pdf text-6xl text-red-600 mb-4 animate-fade-in-up"></i>
                        <h3 class="text-2xl font-bold mb-2">Ekspor Laporan Harian ke PDF</h3>
                        <p class="text-gray-600 mb-6">Unduh laporan absensi hari ini dalam format PDF.</p>
                        <button id="export-pdf-button" class="py-3 px-8 text-white font-medium rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 flex items-center justify-center mx-auto" style="background: linear-gradient(135deg, #4f46e5, #3b82f6);">
                            <i class="fas fa-download mr-2"></i> Unduh PDF
                        </button>
                    </div>
                </div>

                <!-- Konten Ekspor Excel -->
                <div id="export-excel-content" class="p-6 hidden">
                    <div class="text-center">
                        <i class="fas fa-file-excel text-6xl text-green-600 mb-4 animate-fade-in-up"></i>
                        <h3 class="text-2xl font-bold mb-2">Ekspor Data Riwayat ke Excel</h3>
                        <p class="text-gray-600 mb-6">Unduh seluruh riwayat absensi dalam format CSV (dapat dibuka dengan Excel).</p>
                        <button id="export-excel-button-content" class="py-3 px-8 text-white font-medium rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 flex items-center justify-center mx-auto" style="background: linear-gradient(135deg, #10b981, #149c71);">
                            <i class="fas fa-download mr-2"></i> Unduh Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Notifikasi -->
    <div id="notification-modal" class="modal">
        <span id="modal-message"></span>
    </div>

    <!-- JS untuk Ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // SANGAT PENTING: Ganti URL di bawah ini dengan URL Google Apps Script Anda yang valid.
        const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbyyt-tYyivLhQvarYI78l0P9NlnhQzD8WXGTdbaj7L_Oce5DjZZ91z5AXezml0FJcdAdw/exec';

        // DATA UNTUK IBU HARLINA SAJA
        const herlinaData = {
            "namaGuru": "HARLINA BASO, S.Pd, Gr",
            "nip": "19830730 200902 2 001",
            "kelas": "IX A",
            "murid": [
                "Ahmad Imam Khadafi", "Aini Rahma Tia G. Haduna", "Alip Ghufron Kelung", "Carli S. Mage", "Debi Aprilia", "Fitri Septiani", "Iqra I. Pobau", "Juliyan", "Magfirah H. Nusa", "Mega Aprilia M. Kelung", "Moh. Akbar Aditia Saputra", "Moh. Jamil", "Moh. Rezky", "Moh. Rizki D. Ismail", "Moh. Rizki Pematai",
                "Muh. Fahril latjeno", "Muhammad farhat", "Nabil m. Kantja", "Nabila putri ayunda", "Nailah destifanisya", "Nur aida y. Djdalali", "Nuraini lamadjido", "Nurul vaizya", "Qanita aulia qalbi", "Rahmat reza s.palanewen", "Riska maulida r. Singgo", "Risman", "Suai b. Legu", "Uyun nurjanah tarampu"
            ]
        };

        // Referensi Elemen DOM
        const landingPage = document.getElementById('landing-page');
        const startButton = document.getElementById('start-button');
        const mainApp = document.getElementById('main-app');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const teacherDetailsDiv = document.getElementById('teacher-details');
        const teacherNameSpan = document.getElementById('teacher-name');
        const teacherNipSpan = document.getElementById('teacher-nip');
        const teacherClassSpan = document.getElementById('teacher-class');
        const studentListDiv = document.getElementById('student-list');
        const markAllPresentBtn = document.getElementById('mark-all-present');
        const attendanceSummaryDiv = document.getElementById('attendance-summary');
        const [countHadir, countSakit, countIzin, countAlfa] = [
            document.getElementById('count-hadir'),
            document.getElementById('count-sakit'),
            document.getElementById('count-izin'),
            document.getElementById('count-alfa')
        ];
        const backButton = document.getElementById('back-button');
        const backButtonContainer = document.getElementById('back-button-container');
        const historyContainer = document.getElementById('history-container');
        const historyTableContainer = document.getElementById('history-table-container');
        const historySearchInput = document.getElementById('history-search-input');
        const historyFilterDate = document.getElementById('history-filter-date');
        const historyFilterStatus = document.getElementById('history-filter-status');
        const appTitle = document.getElementById('app-title');
        const appSubtitle = document.getElementById('app-subtitle');
        const contentContainer = document.getElementById('content-container');

        const menuAbsenSiswa = document.getElementById('menu-absen-siswa');
        const menuDataSiswa = document.getElementById('menu-data-siswa');
        const menuExportPdf = document.getElementById('menu-export-pdf');
        const menuExportExcel = document.getElementById('menu-export-excel');
        const exportPdfButton = document.getElementById('export-pdf-button');
        const exportExcelButton = document.getElementById('export-excel-button-content');
        const exportPdfContent = document.getElementById('export-pdf-content');
        const exportExcelContent = document.getElementById('export-excel-content');
        const tabs = [menuAbsenSiswa, menuDataSiswa, menuExportPdf, menuExportExcel];

        // State Aplikasi
        let currentAttendanceState = {};
        let historicalAttendanceState = {};
        let selectedTeacherData = herlinaData;
        let selectedTeacherName = herlinaData.namaGuru;
        let currentView = 'absen';

        /**
         * Menampilkan modal notifikasi.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {string} type - Tipe notifikasi ('success' atau 'error').
         */
        function showNotification(message, type) {
            const modal = document.getElementById('notification-modal');
            const msgSpan = document.getElementById('modal-message');
            modal.classList.remove('modal-success', 'modal-error');
            modal.classList.add(`modal-${type}`);
            msgSpan.textContent = message;
            modal.classList.add('show');
            setTimeout(() => {
                modal.classList.remove('show');
            }, 3000);
        }

        /**
         * Memuat state absensi dari Local Storage.
         */
        function loadAttendanceState() {
            const savedToday = localStorage.getItem('absensi_guru_wali_state_herlina');
            currentAttendanceState = savedToday ? JSON.parse(savedToday) : {};
            
            const savedHistory = localStorage.getItem('absensi_guru_wali_riwayat_herlina');
            historicalAttendanceState = savedHistory ? JSON.parse(savedHistory) : {};
        }

        /**
         * Menyimpan state absensi ke Local Storage.
         */
        function saveAttendanceState() {
            localStorage.setItem('absensi_guru_wali_state_herlina', JSON.stringify(currentAttendanceState));
            localStorage.setItem('absensi_guru_wali_riwayat_herlina', JSON.stringify(historicalAttendanceState));
        }

        /**
         * Mengirim data absensi ke Google Apps Script Web App.
         * @param {object} data - Data absensi untuk dikirim.
         */
        async function sendToSpreadsheet(data) {
            try {
                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Permintaan dikirim. Menunggu konfirmasi...');
                showNotification('Data absensi berhasil dikirim.', 'success');
            } catch (error) {
                console.error('Ada masalah saat mengirim data:', error);
                showNotification('Gagal mengirim data. Periksa koneksi atau URL.', 'error');
            }
        }

        /**
         * Memperbarui ringkasan kehadiran berdasarkan state saat ini.
         */
        function updateSummary() {
            let counts = { hadir: 0, sakit: 0, izin: 0, alfa: 0 };
            const today = new Date().toDateString();

            if (currentAttendanceState[selectedTeacherName]) {
                for (const student in currentAttendanceState[selectedTeacherName]) {
                    const data = currentAttendanceState[selectedTeacherName][student];
                    if (new Date(data.date).toDateString() === today) {
                        const status = data.status;
                        if (status && counts[status] !== undefined) {
                            counts[status]++;
                        }
                    }
                }
            }

            countHadir.textContent = counts.hadir;
            countSakit.textContent = counts.sakit;
            countIzin.textContent = counts.izin;
            countAlfa.textContent = counts.alfa;
        }

        /**
         * Merender daftar murid untuk guru yang dipilih.
         * @param {string[]} students - Array nama murid.
         * @param {string} teacherName - Nama guru yang dipilih.
         */
        function renderStudents(students, teacherName) {
            hideAllContent();
            studentListDiv.classList.remove('hidden');
            backButtonContainer.classList.add('hidden');
            
            appTitle.textContent = "Absen Siswa Hari Ini";
            appSubtitle.textContent = "Pilih status kehadiran setiap siswa.";

            studentListDiv.innerHTML = '';
            
            const today = new Date().toDateString();

            students.forEach((student, index) => {
                const teacherAttendance = currentAttendanceState[teacherName] || {};
                let data = teacherAttendance[student];

                if (!data || new Date(data.date).toDateString() !== today) {
                    data = { status: 'hadir', date: new Date().toISOString() };
                    if (!currentAttendanceState[teacherName]) {
                        currentAttendanceState[teacherName] = {};
                    }
                    currentAttendanceState[teacherName][student] = data;
                }

                const item = document.createElement('div');
                item.className = 'p-4 bg-white rounded-lg shadow border border-gray-200 flex flex-col sm:flex-row justify-between items-start transition-all duration-300 hover:shadow-md animate-fade-in-up';
                item.style.animationDelay = `${index * 0.05}s`;
                item.innerHTML = `
                    <div class="mb-2 sm:mb-0 sm:mr-4 flex items-center">
                        <span class="font-bold text-indigo-600 mr-2">${index + 1}.</span>
                        <span class="text-gray-700 font-medium">${student}</span>
                        <i id="confirm-icon-${index}" class="fas fa-check-circle ml-2 text-green-500 hidden opacity-0"></i>
                    </div>
                    <div class="flex space-x-2 flex-wrap sm:flex-nowrap" data-student="${student}">
                        <button class="btn-status hadir ${data.status === 'hadir' ? 'active' : ''}" data-status="hadir"><i class="fas fa-check mr-1"></i> Hadir</button>
                        <button class="btn-status sakit ${data.status === 'sakit' ? 'active' : ''}" data-status="sakit"><i class="fas fa-procedures mr-1"></i> Sakit</button>
                        <button class="btn-status izin ${data.status === 'izin' ? 'active' : ''}" data-status="izin"><i class="fas fa-hand-paper mr-1"></i> Izin</button>
                        <button class="btn-status alfa ${data.status === 'alfa' ? 'active' : ''}" data-status="alfa"><i class="fas fa-times mr-1"></i> Alfa</button>
                    </div>
                `;
                studentListDiv.appendChild(item);
            });
            
            studentListDiv.innerHTML += `
                <div id="action-buttons" class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                    <button id="mark-all-present" class="py-2 px-5 w-full sm:w-auto bg-gray-200 text-gray-800 font-medium rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-check-double mr-2"></i> Tandai Semua Hadir
                    </button>
                </div>
                 <div id="attendance-summary" class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Ringkasan Hari Ini</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="summary-card p-4 rounded-xl shadow bg-green-50 border border-green-100">
                            <i class="fas fa-check-circle text-green-500 text-xl mb-1"></i>
                            <p class="text-2xl font-bold text-green-700" id="count-hadir">0</p>
                            <p class="text-sm text-green-600 mt-1">Hadir</p>
                        </div>
                        <div class="summary-card p-4 rounded-xl shadow bg-yellow-50 border border-yellow-100">
                            <i class="fas fa-procedures text-yellow-500 text-xl mb-1"></i>
                            <p class="text-2xl font-bold text-yellow-700" id="count-sakit">0</p>
                            <p class="text-sm text-yellow-600 mt-1">Sakit</p>
                        </div>
                        <div class="summary-card p-4 rounded-xl shadow bg-blue-50 border border-blue-100">
                            <i class="fas fa-hand-paper text-blue-500 text-xl mb-1"></i>
                            <p class="text-2xl font-bold text-blue-700" id="count-izin">0</p>
                            <p class="text-sm text-blue-600 mt-1">Izin</p>
                        </div>
                        <div class="summary-card p-4 rounded-xl shadow bg-red-50 border border-red-100">
                            <i class="fas fa-times-circle text-red-500 text-xl mb-1"></i>
                            <p class="text-2xl font-bold text-red-700" id="count-alfa">0</p>
                            <p class="text-sm text-red-600 mt-1">Alfa</p>
                        </div>
                    </div>
                </div>`;

            document.getElementById('mark-all-present').addEventListener('click', markAllPresent);
            studentListDiv.querySelectorAll('.btn-status').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const container = e.target.closest('div[data-student]');
                    const student = container.dataset.student;
                    const status = e.target.dataset.status;

                    container.querySelectorAll('.btn-status').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    const guruData = herlinaData;
                    const kelas = guruData ? guruData.kelas : '';
                    
                    const date = new Date();
                    const dataToSend = {
                        NamaGuru: selectedTeacherName,
                        Kelas: kelas,
                        NamaMurid: student,
                        Tanggal: date.getDate(),
                        Bulan: date.getMonth() + 1,
                        Tahun: date.getFullYear(),
                        Keterangan: status
                    };

                    const studentItem = e.target.closest('.flex-col.sm\\:flex-row');
                    const confirmIcon = studentItem.querySelector('i[id^="confirm-icon"]');
                    if (confirmIcon) {
                        confirmIcon.classList.remove('hidden', 'opacity-0');
                        confirmIcon.classList.add('animate-confirm');
                        setTimeout(() => {
                            confirmIcon.classList.remove('animate-confirm');
                            confirmIcon.classList.add('hidden', 'opacity-0');
                        }, 1000);
                    }

                    if (!currentAttendanceState[selectedTeacherName]) {
                        currentAttendanceState[selectedTeacherName] = {};
                    }
                    currentAttendanceState[selectedTeacherName][student] = { status, date: date.toISOString() };

                    if (!historicalAttendanceState[selectedTeacherName]) {
                        historicalAttendanceState[selectedTeacherName] = {};
                    }
                    if (!historicalAttendanceState[selectedTeacherName][student]) {
                        historicalAttendanceState[selectedTeacherName][student] = [];
                    }
                    const existingIndex = historicalAttendanceState[selectedTeacherName][student].findIndex(rec => new Date(rec.date).toDateString() === date.toDateString());
                    if (existingIndex !== -1) {
                         historicalAttendanceState[selectedTeacherName][student][existingIndex] = {
                            status,
                            date: date.toISOString(),
                            kelas,
                            nama: student,
                            hari: date.toLocaleDateString('id-ID', { weekday: 'long' }),
                            tanggal: date.getDate(),
                            bulan: date.getMonth() + 1,
                            tahun: date.getFullYear()
                        };
                    } else {
                        historicalAttendanceState[selectedTeacherName][student].push({
                            status,
                            date: date.toISOString(),
                            kelas,
                            nama: student,
                            hari: date.toLocaleDateString('id-ID', { weekday: 'long' }),
                            tanggal: date.getDate(),
                            bulan: date.getMonth() + 1,
                            tahun: date.getFullYear()
                        });
                    }

                    sendToSpreadsheet(dataToSend);
                    saveAttendanceState();
                    updateSummary();
                });
            });
            updateSummary();
        }

        /**
         * Merender tabel riwayat absensi (Data Siswa)
         */
        function renderHistoryTable() {
            hideAllContent();
            historyContainer.classList.remove('hidden');
            backButtonContainer.classList.remove('hidden');
            
            appTitle.textContent = "Riwayat Absensi Siswa";
            appSubtitle.textContent = "Cari atau filter data absensi di bawah ini.";

            const teacherHistory = historicalAttendanceState[selectedTeacherName] || {};
            const searchTerm = historySearchInput.value.toLowerCase();
            const filterStatus = historyFilterStatus.value;
            const filterDate = historyFilterDate.value;
            
            let allRecords = [];
            for (const student in teacherHistory) {
                const records = teacherHistory[student];
                records.forEach(record => allRecords.push(record));
            }
            
            allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            const filteredRecords = allRecords.filter(record => {
                const matchesSearch = record.nama.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'semua' || record.status === filterStatus;
                const matchesDate = !filterDate || new Date(record.date).toISOString().split('T')[0] === filterDate;
                return matchesSearch && matchesStatus && matchesDate;
            });
            
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bulan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            if (filteredRecords.length > 0) {
                filteredRecords.forEach(record => {
                    const statusText = {
                        hadir: "Hadir",
                        sakit: "Sakit",
                        izin: "Izin",
                        alfa: "Alfa"
                    }[record.status] || "Tidak Diketahui";
                    
                    tableHTML += `
                        <tr class="history-table-row">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.hari}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.tanggal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.bulan}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.tahun}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${record.status === 'hadir' ? 'text-green-600' : record.status === 'sakit' ? 'text-yellow-600' : record.status === 'izin' ? 'text-blue-600' : 'text-red-600'}">
                                ${statusText}
                            </td>
                        </tr>
                    `;
                });
            } else {
                tableHTML += `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">Tidak ada data yang cocok dengan kriteria.</td>
                    </tr>
                `;
            }

            tableHTML += `
                    </tbody>
                </table>
            `;

            historyTableContainer.innerHTML = tableHTML;
        }

        /**
         * Mengekspor laporan absensi ke file PDF.
         */
        function exportToPDF() {
            hideAllContent();
            exportPdfContent.classList.remove('hidden');
            backButtonContainer.classList.remove('hidden');
            appTitle.textContent = "Ekspor Laporan PDF";
            appSubtitle.textContent = "Unduh laporan absensi harian kelas Anda.";
            // Logic to generate PDF is inside the event listener for the button
        }
        function performPdfExport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            const today = new Date().toLocaleDateString('id-ID');
            
            doc.setFontSize(18);
            doc.setTextColor(45, 55, 72);
            doc.text("Laporan Absensi", 105, y, null, null, "center");
            y += 10;
            doc.setFontSize(12);
            doc.text(`Tanggal: ${today}`, 105, y, null, null, "center");
            y += 15;

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(`Wali Guru: ${selectedTeacherData.namaGuru}`, 20, y);
            y += 7;
            doc.text(`Kelas: ${selectedTeacherData.kelas}`, 20, y);
            y += 7;
            doc.text(`NIP: ${selectedTeacherData.nip || '-'}`, 20, y);
            y += 15;

            doc.setFillColor(66, 139, 202);
            doc.setTextColor(255, 255, 255);
            doc.rect(20, y - 2, 170, 8, 'F');
            doc.text(["No.", "Nama", "Status"], [22, 45, 120], y + 3);
            y += 12;

            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0);
            
            const students = selectedTeacherData.murid;
            students.forEach((s, i) => {
                const data = currentAttendanceState[selectedTeacherName]?.[s] || { status: 'hadir', date: new Date().toISOString() };
                const statusText = { hadir: "Hadir", sakit: "Sakit", izin: "Izin", alfa: "Alfa" }[data.status];
                
                if (new Date(data.date).toDateString() === new Date().toDateString()) {
                    doc.text(`${i+1}.`, 22, y);
                    doc.text(s, 45, y);
                    doc.text(statusText, 120, y);
                    y += 7;
                }
            });

            doc.save(`Absensi_${selectedTeacherData.kelas}_${selectedTeacherData.namaGuru.replace(/\W+/g, '')}_Hari_Ini.pdf`);
            showNotification('Laporan PDF berhasil diunduh.', 'success');
        }

        /**
         * Mengekspor data riwayat ke file Excel (CSV).
         */
        function exportToExcel() {
            hideAllContent();
            exportExcelContent.classList.remove('hidden');
            backButtonContainer.classList.remove('hidden');
            appTitle.textContent = "Ekspor Laporan Excel";
            appSubtitle.textContent = "Unduh seluruh riwayat absensi kelas Anda.";
        }
        function performExcelExport() {
            const teacherHistory = historicalAttendanceState[selectedTeacherName] || {};
            const allRecords = [];
            for (const student in teacherHistory) {
                const records = teacherHistory[student];
                records.forEach(record => allRecords.push(record));
            }

            if (allRecords.length === 0) {
                showNotification('Tidak ada data riwayat untuk diekspor.', 'error');
                return;
            }

            const header = "Nama Siswa,Kelas,Hari,Tanggal,Bulan,Tahun,Keterangan\n";
            const rows = allRecords.map(record => {
                const statusText = { hadir: "Hadir", sakit: "Sakit", izin: "Izin", alfa: "Alfa" }[record.status] || "Tidak Diketahui";
                return `"${record.nama}","${record.kelas}","${record.hari}","${record.tanggal}","${record.bulan}","${record.tahun}","${statusText}"`;
            }).join('\n');

            const csvContent = header + rows;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Riwayat_Absensi_${selectedTeacherData.kelas}_${selectedTeacherData.namaGuru.replace(/\W+/g, '')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Data Excel berhasil diunduh.', 'success');
        }

        const markAllPresent = () => {
            const students = selectedTeacherData.murid;
            const date = new Date();
            if (!currentAttendanceState[selectedTeacherName]) {
                currentAttendanceState[selectedTeacherName] = {};
            }
            if (!historicalAttendanceState[selectedTeacherName]) {
                historicalAttendanceState[selectedTeacherName] = {};
            }

            students.forEach(student => {
                const record = { status: 'hadir', date: date.toISOString() };
                currentAttendanceState[selectedTeacherName][student] = record;
                
                if (!historicalAttendanceState[selectedTeacherName][student]) {
                    historicalAttendanceState[selectedTeacherName][student] = [];
                }
                const existingIndex = historicalAttendanceState[selectedTeacherName][student].findIndex(rec => new Date(rec.date).toDateString() === date.toDateString());
                if (existingIndex !== -1) {
                     historicalAttendanceState[selectedTeacherName][student][existingIndex] = {
                        ...record,
                        kelas: selectedTeacherData.kelas,
                        nama: student,
                        hari: date.toLocaleDateString('id-ID', { weekday: 'long' }),
                        tanggal: date.getDate(),
                        bulan: date.getMonth() + 1,
                        tahun: date.getFullYear()
                    };
                } else {
                    historicalAttendanceState[selectedTeacherName][student].push({
                        ...record,
                        kelas: selectedTeacherData.kelas,
                        nama: student,
                        hari: date.toLocaleDateString('id-ID', { weekday: 'long' }),
                        tanggal: date.getDate(),
                        bulan: date.getMonth() + 1,
                        tahun: date.getFullYear()
                    });
                }
            });
            saveAttendanceState();
            renderStudents(students, selectedTeacherName);
            showNotification('Semua siswa berhasil ditandai Hadir.', 'success');
        };

        const setActiveTab = (tabId) => {
            document.querySelectorAll('.tab-menu').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        };

        const hideAllContent = () => {
            studentListDiv.classList.add('hidden');
            historyContainer.classList.add('hidden');
            exportPdfContent.classList.add('hidden');
            exportExcelContent.classList.add('hidden');
        };
        
        // Event Listeners
        window.onload = () => {
            loadAttendanceState();
        };

        document.addEventListener('DOMContentLoaded', () => {
            landingPage.classList.remove('hidden');
            mainApp.classList.add('hidden');
        });

        startButton.addEventListener('click', () => {
            landingPage.classList.add('opacity-0');
            setTimeout(() => {
                landingPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                teacherDashboard.classList.remove('hidden');
                renderStudents(selectedTeacherData.murid, selectedTeacherName);
                setActiveTab('menu-absen-siswa');
            }, 500);
        });

        backButton.addEventListener('click', () => {
            renderStudents(selectedTeacherData.murid, selectedTeacherName);
            setActiveTab('menu-absen-siswa');
            backButtonContainer.classList.add('hidden');
            appTitle.textContent = selectedTeacherData.namaGuru;
            appSubtitle.textContent = `Pilih menu untuk ${selectedTeacherData.kelas}.`;
        });
        
        menuAbsenSiswa.addEventListener('click', () => {
            renderStudents(selectedTeacherData.murid, selectedTeacherName);
            setActiveTab('menu-absen-siswa');
            backButtonContainer.classList.add('hidden');
        });
        menuDataSiswa.addEventListener('click', () => {
            renderHistoryTable();
            setActiveTab('menu-data-siswa');
            backButtonContainer.classList.remove('hidden');
        });
        menuExportPdf.addEventListener('click', () => {
            hideAllContent();
            exportPdfContent.classList.remove('hidden');
            setActiveTab('menu-export-pdf');
            backButtonContainer.classList.remove('hidden');
        });
        menuExportExcel.addEventListener('click', () => {
            hideAllContent();
            exportExcelContent.classList.remove('hidden');
            setActiveTab('menu-export-excel');
            backButtonContainer.classList.remove('hidden');
        });

        historySearchInput.addEventListener('input', renderHistoryTable);
        historyFilterDate.addEventListener('change', renderHistoryTable);
        historyFilterStatus.addEventListener('change', renderHistoryTable);

        exportPdfButton.addEventListener('click', () => performPdfExport());
        exportExcelButton.addEventListener('click', () => performExcelExport());
        
        document.addEventListener('click', (e) => {
            if (e.target.id === 'mark-all-present' || e.target.closest('#mark-all-present')) {
                markAllPresent();
            }
        });
    </script>
</body>
</html>
