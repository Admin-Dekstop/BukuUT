<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Siswa Guru Wali</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Pustaka jsPDF dan jspdf-autotable untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
        }
        .container-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 900px;
            animation: fadeInScale 0.8s ease-out forwards;
        }
        @media (min-width: 768px) {
            .container-card {
                padding: 4rem;
            }
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.98);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .teacher-card {
            background: #e0f7fa;
            border-left: 6px solid #00bcd4;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
        }
        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }
        .student-item {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.3s ease-in-out;
            cursor: pointer;
        }
        .student-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            background-color: #f0f4f8;
        }
        ol li::marker {
            font-weight: 700;
            color: #4a5568;
            font-size: 1.1em;
        }
        .text-shadow {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Modal styling */
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: none; /* Default to hidden */
            opacity: 0;
        }
        .modal.show {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        .card-icon {
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }
        .list-item-icon {
            font-size: 1rem;
            margin-right: 0.5rem;
            color: #6b7280;
        }
        /* Mobile-first adjustments */
        .flex-wrap-buttons {
            flex-wrap: wrap;
            justify-content: center;
        }
        .flex-wrap-buttons > * {
            flex-grow: 1;
            margin: 0.25rem;
        }
        @media (min-width: 640px) {
            .flex-wrap-buttons {
                flex-wrap: nowrap;
            }
            .flex-wrap-buttons > * {
                flex-grow: 0;
                margin: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

    <!-- Main Container -->
    <div class="container-card">
        <div class="text-center mb-8 md:mb-12">
            <i class="fas fa-graduation-cap text-5xl text-blue-500 mb-4 animate-bounce"></i>
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-800 mb-2 text-shadow">Daftar Siswa Guru Wali</h1>
            <p class="text-md md:text-lg text-gray-500 font-medium">Solusi digital untuk manajemen data siswa yang efisien.</p>
        </div>

        <!-- Kartu informasi guru wali -->
        <div class="teacher-card p-6 md:p-8 rounded-xl shadow-lg mb-8 md:mb-12">
            <h2 class="text-2xl md:text-3xl font-bold text-teal-700 mb-2 flex items-center">
                <i class="fas fa-chalkboard-user text-teal-600 mr-3"></i>
                Informasi Wali Kelas
            </h2>
            <p class="text-xl md:text-2xl text-teal-800 font-semibold mb-1">HARLINA BASO, S.Pd, Gr</p>
            <p class="text-sm md:text-lg text-teal-600 mt-2">NIP: 19830730 200902 2 001</p>
            <div class="mt-4 text-sm text-teal-500">
                <p>Wali Kelas: IX A</p>
            </div>
        </div>

        <!-- Bagian tanggal dan filter absensi -->
        <div class="mb-6 flex flex-col md:flex-row md:items-center justify-between">
            <div class="mb-4 md:mb-0">
                <label for="tanggal-absen" class="block text-gray-700 font-semibold mb-1">Pilih Tanggal:</label>
                <input type="date" id="tanggal-absen" class="w-full md:w-auto px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex space-x-2 md:space-x-4 flex-wrap-buttons">
                <button id="filter-all" class="px-4 py-2 rounded-lg font-semibold text-white bg-blue-500 hover:bg-blue-600 transition-colors">
                    <i class="fas fa-users-line mr-2"></i>Semua Siswa
                </button>
                <button id="filter-present" class="px-4 py-2 rounded-lg font-semibold text-white bg-green-500 hover:bg-green-600 transition-colors">
                    <i class="fas fa-user-check mr-2"></i>Hadir
                </button>
                <button id="filter-absent" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors">
                    <i class="fas fa-user-xmark mr-2"></i>Tidak Hadir
                </button>
            </div>
        </div>
        
        <!-- Kontainer untuk data yang akan diunduh PDF -->
        <div id="pdf-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl md:text-3xl font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-clipboard-user text-gray-500 mr-3"></i>
                    Daftar Absensi Siswa
                </h2>
                <span id="tanggal-tampil" class="text-gray-600 text-sm md:text-base font-medium"></span>
            </div>

            <ul id="student-list" class="bg-gray-50 border border-gray-200 rounded-lg p-4 md:p-6 space-y-4">
                <!-- Daftar siswa akan di-render di sini oleh JavaScript -->
            </ul>
        </div>
        
        <!-- Tombol Ekspor PDF -->
        <div class="mt-8 text-center" id="pdf-export-container">
            <button id="download-pdf-btn" class="px-6 py-3 bg-indigo-500 text-white font-bold rounded-lg shadow-md hover:bg-indigo-600 transition-colors">
                <i class="fas fa-file-pdf mr-2"></i> Ekspor PDF
            </button>
        </div>
    </div>

    <!-- Modal untuk menampilkan penanganan masalah dan pesan error/berhasil -->
    <div id="modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-xl overflow-y-auto max-h-[90vh]">
            <h3 id="modal-title" class="text-xl md:text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 text-sm md:text-base mb-6"></p>
            
            <div id="modal-content-area">
                <!-- Konten dinamis seperti profil siswa atau pesan error akan dimasukkan di sini -->
            </div>

            <button id="modal-close" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors w-full md:w-auto mt-4">Tutup</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const studentListElement = document.getElementById('student-list');
            const tanggalInput = document.getElementById('tanggal-absen');
            const tanggalTampil = document.getElementById('tanggal-tampil');
            const filterAllButton = document.getElementById('filter-all');
            const filterPresentButton = document.getElementById('filter-present');
            const filterAbsentButton = document.getElementById('filter-absent');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const pdfExportContainer = document.getElementById('pdf-export-container');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalContentArea = document.getElementById('modal-content-area');
            const modalCloseButton = document.getElementById('modal-close');

            const allStudents = [
                "Muh. Fahril latjeno", "Muhammad farhat", "Nabil m. Kantja", "Nabila putri ayunda",
                "Nailah destifanisya", "Nur aida y. Djdalali", "Nuraini lamadjido", "Nurul vaizya",
                "Qanita aulia qalbi", "Rahmat reza s.palanewen", "Riska maulida r. Singgo", "Risman",
                "Suaib h. Legu", "Uyun nurjanah tarampu"
            ];

            let attendanceRecords = [];

            function createMockData() {
                const dates = ['2023-11-20', '2023-11-21', '2023-11-22', '2023-11-23'];
                const statuses = ['present', 'absent'];
                dates.forEach(date => {
                    allStudents.forEach(student => {
                        const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                        attendanceRecords.push({
                            date: date,
                            name: student,
                            status: randomStatus
                        });
                    });
                });
            }
            createMockData();

            const tugasGuruWali = `
                <ul class="list-disc list-inside space-y-2 text-sm md:text-base">
                    <li><i class="fas fa-clipboard-check list-item-icon"></i>**Administrasi & Organisasi:** Mengelola data siswa, absensi, dan rapor.</li>
                    <li><i class="fas fa-hand-holding-heart list-item-icon"></i>**Pembinaan & Bimbingan:** Membimbing karakter dan motivasi siswa secara personal.</li>
                    <li><i class="fas fa-comments list-item-icon"></i>**Komunikasi & Sosial:** Menjadi penghubung utama antara siswa, orang tua, dan pihak sekolah.</li>
                    <li><i class="fas fa-chart-line list-item-icon"></i>**Evaluasi & Pelaporan:** Memantau perkembangan siswa dan menyusun laporan secara berkala.</li>
                </ul>
            `;
            
            const dataSiswa = {
                "Muh. Fahril latjeno": {
                    profile: "Siswa yang aktif dan memiliki banyak teman. Perlu bimbingan dalam manajemen waktu agar tidak mengganggu fokus belajar.",
                    penanganan: {
                        title: "Penanganan Masalah: Manajemen Waktu",
                        description: "Fahril perlu belajar menyeimbangkan antara kegiatan sosial dan akademis.",
                        steps: ["Diskusikan jadwal harian dengannya, bantu susun prioritas.", "Berikan tantangan akademis yang menarik untuk meningkatkan motivasinya di kelas.", "Libatkan orang tua dalam memantau jadwal belajar di rumah."]
                    }
                },
                "Muhammad farhat": {
                    profile: "Siswa dengan potensi akademis tinggi namun kurang percaya diri untuk menonjol.",
                    penanganan: {
                        title: "Penanganan Masalah: Kepercayaan Diri",
                        description: "Farhat perlu didorong untuk lebih berani menunjukkan potensinya.",
                        steps: ["Berikan apresiasi publik untuk setiap pencapaiannya.", "Tunjuk ia sebagai tutor sebaya untuk teman yang kesulitan.", "Dorong untuk berpartisipasi dalam kegiatan ekstrakurikuler yang sesuai minatnya."]
                    }
                },
                "Risman": {
                    profile: "Siswa yang sering absen tanpa keterangan. Perlu perhatian khusus terhadap kehadiran.",
                    penanganan: {
                        title: "Penanganan Masalah: Kedisiplinan Kehadiran",
                        description: "Masalah kehadiran Risman harus segera ditangani agar tidak mengganggu proses belajarnya.",
                        steps: ["Hubungi orang tua atau wali untuk mencari tahu penyebab absen.", "Berikan konseling untuk memahami apa yang membuatnya enggan ke sekolah.", "Buat perjanjian atau kesepakatan tertulis bersama orang tua untuk memantau kehadirannya."]
                    }
                },
                 "default": {
                    profile: "Siswa dengan rekam jejak yang baik. Tidak ada masalah khusus yang tercatat. Lanjutkan pembinaan umum.",
                    penanganan: {
                        title: "Penanganan Masalah: Pembinaan Umum",
                        description: "Siswa ini berada di jalur yang benar. Berikut adalah tugas pembinaan umum:",
                        steps: ["Terus berikan dukungan dan motivasi.", "Pantau terus perkembangan akademis dan sosialnya.", "Pastikan tidak ada masalah yang tersembunyi dengan komunikasi terbuka."]
                    }
                }
            };

            const getTodayDateString = () => {
                const date = new Date();
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };
            const getFormattedDate = (dateString) => {
                const date = new Date(dateString);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('id-ID', options);
            };
            
            let currentFilter = 'all';

            function showModal(title, message, contentHtml = '') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalContentArea.innerHTML = contentHtml;
                modal.classList.remove('hidden');
                modal.classList.add('show');
            }

            function renderStudents(date) {
                studentListElement.innerHTML = '';
                tanggalTampil.textContent = getFormattedDate(date);
                
                pdfExportContainer.classList.toggle('hidden', currentFilter !== 'present' && currentFilter !== 'absent');
                
                let studentsForDate = allStudents.map(name => {
                    const record = attendanceRecords.find(rec => rec.date === date && rec.name === name);
                    return { name: name, status: record ? record.status : 'unknown' };
                });

                const filteredStudents = studentsForDate.filter(student => {
                    if (currentFilter === 'all') return true;
                    return student.status === currentFilter;
                });

                if (filteredStudents.length === 0) {
                    studentListElement.innerHTML = `<li class="text-center text-gray-500 font-medium py-8">Tidak ada data siswa untuk filter ini.</li>`;
                    return;
                }

                filteredStudents.forEach((student, index) => {
                    const listItem = document.createElement('li');
                    const statusColor = student.status === 'present' ? 'bg-green-100 border-green-300' : 
                                        student.status === 'absent' ? 'bg-red-100 border-red-300' : 'bg-gray-100 border-gray-200';
                    const statusIcon = student.status === 'present' ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>' : 
                                        student.status === 'absent' ? '<i class="fas fa-times-circle text-red-500 mr-2"></i>' : '';

                    listItem.className = `p-4 rounded-md shadow-sm border ${statusColor} text-gray-700 flex items-center justify-between`;
                    
                    const nameContainer = document.createElement('div');
                    nameContainer.className = "flex items-center space-x-2";
                    nameContainer.innerHTML = `<span class="font-bold text-gray-600 mr-2">${allStudents.indexOf(student.name) + 1}.</span>${statusIcon}<span>${student.name}</span>`;

                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = "flex items-center space-x-2";

                    const isToday = tanggalInput.value === getTodayDateString();
                    const hasStatus = student.status !== 'unknown';

                    if (isToday && !hasStatus) {
                        const absentButton = document.createElement('button');
                        absentButton.innerHTML = '<i class="fas fa-user-xmark"></i>';
                        absentButton.className = "px-3 py-1 text-red-500 rounded-md hover:bg-red-200 transition-colors";
                        absentButton.onclick = (e) => {
                            e.stopPropagation();
                            attendanceRecords.push({ date: date, name: student.name, status: 'absent' });
                            renderStudents(date);
                        };
                        
                        const presentButton = document.createElement('button');
                        presentButton.innerHTML = '<i class="fas fa-user-check"></i>';
                        presentButton.className = "px-3 py-1 text-green-500 rounded-md hover:bg-green-200 transition-colors";
                        presentButton.onclick = (e) => {
                            e.stopPropagation();
                            attendanceRecords.push({ date: date, name: student.name, status: 'present' });
                            renderStudents(date);
                        };

                        actionsContainer.appendChild(presentButton);
                        actionsContainer.appendChild(absentButton);
                    } else if (hasStatus) {
                        const infoButton = document.createElement('button');
                        infoButton.innerHTML = '<i class="fas fa-info-circle"></i>';
                        infoButton.className = "px-3 py-1 text-gray-400 rounded-md hover:bg-gray-200 transition-colors";
                        infoButton.onclick = (e) => {
                            e.stopPropagation();
                            showStudentInfo(student.name);
                        };
                        actionsContainer.appendChild(infoButton);
                    }

                    listItem.appendChild(nameContainer);
                    listItem.appendChild(actionsContainer);
                    studentListElement.appendChild(listItem);
                });
            }

            function showStudentInfo(studentName) {
                const data = dataSiswa[studentName] || dataSiswa.default;
                
                let contentHtml = `
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-id-card card-icon text-gray-600"></i>
                            Profil Singkat
                        </h4>
                        <p id="profile-siswa" class="text-gray-600 text-sm md:text-base">${data.profile}</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-tasks card-icon text-gray-600"></i>
                            Tugas Umum Guru Wali
                        </h4>
                        <div id="tugas-wali-content" class="text-gray-600 text-sm md:text-base">${tugasGuruWali}</div>
                    </div>
                `;
                
                if (data.penanganan) {
                    contentHtml += `
                        <div id="penanganan-khusus-section" class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                                <i class="fas fa-exclamation-triangle card-icon text-red-500"></i>
                                Penanganan Masalah Khusus
                            </h4>
                            <div id="penanganan-khusus-content" class="text-gray-700 leading-relaxed text-sm md:text-base">
                                <p class="mb-4 text-gray-700">${data.penanganan.description}</p>
                                <ol class="list-decimal list-inside space-y-2">
                                    ${data.penanganan.steps.map(step => `<li>${step}</li>`).join('')}
                                </ol>
                            </div>
                        </div>
                    `;
                }

                showModal(`Informasi Siswa: ${studentName}`, '', contentHtml);
            }

            downloadPdfBtn.addEventListener('click', async () => {
                const selectedDate = tanggalInput.value;
                const filename = `Absensi_Siswa_${selectedDate}.pdf`;

                const originalBtnContent = downloadPdfBtn.innerHTML;
                downloadPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mengekspor...';
                downloadPdfBtn.disabled = true;

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const studentsForDate = allStudents.map(name => {
                        const record = attendanceRecords.find(rec => rec.date === selectedDate && rec.name === name);
                        return { name: name, status: record ? record.status : 'unknown' };
                    });

                    // Filter siswa yang memiliki status (hadir atau tidak hadir)
                    const studentsToExport = studentsForDate.filter(student => student.status === 'present' || student.status === 'absent');
                    
                    if (studentsToExport.length === 0) {
                        showModal("Gagal Ekspor", "Tidak ada data absensi untuk tanggal ini.");
                        return;
                    }

                    const tableHeaders = [["No.", "Nama Siswa", "Status Absensi", "Tanggal"]];
                    const tableData = studentsToExport.map((student, index) => [
                        allStudents.indexOf(student.name) + 1, 
                        student.name, 
                        student.status === 'present' ? 'Hadir' : 'Tidak Hadir',
                        getFormattedDate(selectedDate)
                    ]);

                    pdf.setFontSize(22);
                    pdf.text("Laporan Absensi Siswa", 105, 20, null, null, 'center');
                    pdf.setFontSize(14);
                    pdf.text(`Wali Kelas: HARLINA BASO, S.Pd, Gr`, 105, 30, null, null, 'center');
                    pdf.text(`Tanggal: ${getFormattedDate(selectedDate)}`, 105, 40, null, null, 'center');

                    // Menyesuaikan lebar kolom agar muat di halaman A4
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const availableWidth = pageWidth - 20; // 10mm margin kiri dan kanan
                    const col1 = availableWidth * 0.08; // No
                    const col2 = availableWidth * 0.40; // Nama Siswa
                    const col3 = availableWidth * 0.22; // Status
                    const col4 = availableWidth * 0.30; // Tanggal

                    pdf.autoTable({
                        startY: 50,
                        head: tableHeaders,
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [52, 73, 94] },
                        styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                        columnStyles: { 0: { cellWidth: col1 }, 1: { cellWidth: col2 }, 2: { cellWidth: col3 }, 3: { cellWidth: col4 } }
                    });

                    pdf.save(filename);
                    showModal("Ekspor Berhasil", "Dokumen PDF telah berhasil diunduh.");
                } catch (error) {
                    console.error("Gagal mengekspor PDF: ", error);
                    showModal("Ekspor Gagal", "Terjadi kesalahan saat mengekspor PDF.");
                } finally {
                    downloadPdfBtn.innerHTML = originalBtnContent;
                    downloadPdfBtn.disabled = false;
                }
            });

            filterAllButton.addEventListener('click', () => { currentFilter = 'all'; renderStudents(tanggalInput.value); });
            filterPresentButton.addEventListener('click', () => { currentFilter = 'present'; renderStudents(tanggalInput.value); });
            filterAbsentButton.addEventListener('click', () => { currentFilter = 'absent'; renderStudents(tanggalInput.value); });
            tanggalInput.addEventListener('change', () => { renderStudents(tanggalInput.value); });

            modalCloseButton.addEventListener('click', () => {
                modal.classList.remove('show');
                modal.classList.add('hidden');
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    modal.classList.add('hidden');
                }
            });

            tanggalInput.value = getTodayDateString();
            renderStudents(tanggalInput.value);
        });
    </script>
</body>
</html>
